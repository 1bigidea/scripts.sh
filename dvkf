#!/bin/bash

###############################
# A bunch of helper functions #
###############################
update-changelog() {
	echo "$(dirname $0)";
	/usr/bin/php "$(dirname $0)/php/replace-changelog.php"

}

# Bumps a version number
# Usage: bump-version 3.0.0
bump-version()
{
	VERSION=$1

	# Bump version in readme.txt, *.json en ./*.php files
	sed -i.bak "s/Stable tag: .*/Stable tag: $VERSION/g" readme.txt
	sed -i.bak "s/\"version\": .*/\"version\": \"$VERSION\",/g" *.json
	sed -i.bak "s/define( '\(.*\)_VERSION', .*/define( '\1_VERSION', '$VERSION' );/g; s/Version: .*/Version: $VERSION/g" *.php
		rm *.bak
}

# Pulls languages from Transifex and creates .mo files
# Usage: build-language-files
build-language-files()
{
	if [ -e .tx/config ]; then
		tx pull
	fi
	for file in `find languages/. -name "*.po"` ; do msgfmt -o ${file/.po/.mo} $file; done
}

# Builds assets using Gulp or Grunt
# Usage: build-assets
build-assets()
{
	# Install NPM deps
	if [ -e package.json ] && [ ! -d node_modules ]; then
		sudo npm install
	fi

	# Run Gulp
	if [ -e gulpfile.js ]; then
		gulp
	fi

	# Run Grunt
	if [ -e Gruntfile.js ];	then
		grunt
	fi
}

# Adds various auto-generated files to Git
# Usage: gitadd
gitadd()
{
	git add languages/.
	git commit -m "updated languages"

	git add vendor/.
	git commit -m "updated autoloader"

	git add assets/.
	git commit -m "updated assets"
}

# Creates the Composer autoloader
# Usage: build-autoloader
build-autoloader()
{
	# Run Composer
	if [ -e composer.json ]; then
			# Make sure dev-dependencies are not installed
			if [ -d vendor/phpunit ]; then composer update --no-dev --prefer-dist --optimize-autoloader; fi;
	fi
}
# Lets you call the functions
# Usage: dvkf bump-version 1.0
# Usage: dvkf languages
$1 $2 $3 $4 $5