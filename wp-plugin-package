#!/bin/bash

#########################################
# Prepares a plugin package for release #
#########################################

# Usage: wp-plugin-package $DIR $VERSION $DESTINATION
# Example: wp-plugin-package . 1.0 ~/releases

PLUGIN_DIRECTORY=$1
VERSION=$2

if [ ! -d $PLUGIN_DIRECTORY  ]; then
	echo -e "Plugin directory does not exist"
	exit 1;
fi;

# Traverse into plugin directory
cd $PLUGIN_DIRECTORY
PLUGIN_NAME=${PWD##*/}
DEST=${3:-".."}
DEST="$DEST/$PLUGIN_NAME-$VERSION.zip"

# Build all the things, then bump version
dvkf build-language-files
dvkf build-assets
dvkf build-autoloader
dvkf bump-version $VERSION

# Adds auto-generated files to Git
dvkf gitadd

# Add other untracked changes
git add . -A
git commit -m "[Pre-Release] v$VERSION"

# Create zip file (excludes files from .gitattributes)
echo "Creating release package"
git archive master --format=zip --prefix=$PLUGIN_NAME/ --output=/tmp/$PLUGIN_NAME.zip
mv /tmp/$PLUGIN_NAME.zip $DEST

echo "$DEST created!"

# Go back to where we came from
cd ..